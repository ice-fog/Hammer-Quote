function init() {

    $('[data-toggle="tooltip"]').tooltip();
    $('.category-widget-sidebar').ntm();
    $('.selectpicker').selectpicker();

    contentHandler();
    commentHandler();
    feedbackHandler();
    validateFeedbackForm();
    validateSubscribeForm();
    validateContentForm();
    searchHighlightHandler();
    subscribeHandler();
    validateCommentForm();
    share();
}

function getGETValues() {
    var vars = {};
    location.search.substr(1).replace(/([^=&]+)=([^&]*)/g, function (o, k, v) {
        vars[k] = v;
    });
    return vars;
}

function isNumeric(input) {
    return (input - 0) == input && ('' + input).trim().length > 0;
}

function searchHighlightHandler() {
    if (document.location.href.indexOf('search') < 0) return;
    $(".content-content p").highlight(decodeURI(getGETValues()['search']));

}

function subscribeHandler() {
    $(document).on('click', '.btn-subscribe', function () {
        var formData = $('#subscribe-form').serialize(),
            checkEmail = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
        if (checkEmail.test($('#semail').val())) {
            $.ajax({
                type: 'POST',
                url: '/ajax',
                data: formData + '&action=add-delivery-email',
                success: function (data) {
                    if (data == 'already signed') {
                        bootbox.alert('Вы уже подписаны на рассылку!');
                    } else if (data == 'ok') {
                        bootbox.alert('Подписка на рассылку оформлена!');
                        $('#subscribe-form').trigger('reset');
                    } else {
                        bootbox.alert('Произошла неизвестная ошибка!');
                    }
                }
            });
        } else {
            $('#subscribe-form').submit();
        }
    });
}

function feedbackHandler() {
    $(document).on('click', '.btn-feedback-send', function () {
        var formData = $('#feedback-form').serialize(),
            checkEmail = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
        if ($('#name').val().length > 0 && checkEmail.test($('#email').val()) && $('#message').val().length > 0 && $('#captcha').val().length > 4) {
            $.ajax({
                type: 'POST',
                url: '/ajax',
                data: formData,
                success: function (data) {
                    if (data == 'wrong captcha') {
                        $('#captcha').val("");
                        $('#captcha').closest('.form-group').addClass('has-error');
                    } else if (data == 'ok') {
                        bootbox.alert('Ваше сообщение отправлено!');
                        $('#feedback-form').trigger('reset');
                    } else {
                        bootbox.alert('Произошла неизвестная ошибка!');
                    }
                }
            });
        } else {
            $('#feedback-form').submit();
        }
    });
}


function commentHandler() {
    $(document).on('click', '.btn-reply-comment', function () {
        var id = $(this).closest('.comment-item').attr('id').split('-')[1],
            editor = $('.form-comment'),
            clone = editor.clone();
        editor.remove();
        $(clone).insertAfter("#form-container-" + id).slideDown();
        $("input[name=parent]").val(id);
        validateCommentForm();
    });

    $(document).on('click', '.btn-comment-send', function () {
        var checkEmail = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i,
            formData = $('#comment-form-add').serialize();
        if ($('#name').val().length > 0 && checkEmail.test($('#email').val()) && $('#message').val().length > 0 && $('#captcha').val().length > 4) {
            $.ajax({
                type: 'POST',
                url: '/ajax',
                data: formData,
                success: function (data) {
                    if (data == 'wrong captcha') {
                        $('#captcha').val("");
                        $('#captcha').closest('.form-group').addClass('has-error');
                    } else if (data == 'ok') {
                        bootbox.hideAll();
                        bootbox.alert('Ваш комментарий отправлен на модерацию!');
                        $('#comment-form-add').trigger('reset');
                    } else {
                        bootbox.alert('Произошла неизвестная ошибка!');
                    }
                }
            });
        } else {
            $('#comment-form-add').submit();
        }
    });
}


function contentHandler() {
    $(document).on('click', '.content-content', function () {
        $.post("/ajax", {
                action: 'get-single',
                id: $(this).closest('div.content-item').attr('id').split('-')[1]
            },
            onAjaxSuccess
        );
        function onAjaxSuccess(data) {
            bootbox.dialog({
                    message: data
                }
            );
            validateCommentForm();
        }
    });

    $(document).on('click', '.rating-btn', function () {
        var id = $(this).closest("div.content-item").attr('id').split('-')[1];
        $.ajax({
            type: 'POST',
            url: '/ajax',
            data: {id: id, action: 'update-rating'},
            success: function (data) {
                if (isNumeric(data)) {
                    $('#content-' + id + ' .rating-count').text(data);
                    $('#content-' + id + ' .rating-btn').removeClass('rating-btn').addClass('rating-disabled');
                } else {
                    bootbox.alert('Произошла неизвестная ошибка!');
                }
            }
        });
    });

    $(document).on('click', '.btn-content-add', function () {
        var formData = $('#content-add-form').serialize();
        if ($('#content').val().length > 0 && $('#captcha').val().length > 4) {
            $.ajax({
                type: 'POST',
                url: '/ajax',
                data: formData,
                success: function (data) {
                    if (data == 'wrong captcha') {
                        $('#captcha').val("");
                        $('#captcha').closest('.form-group').addClass('has-error');
                    } else if (data == 'ok') {
                        bootbox.alert("Ваш материал отправлен на модерацию. В ближайшее время он появится на сайте. Спасибо!");
                        $('#content-add-form').trigger('reset');
                    } else {
                        bootbox.alert('Произошла неизвестная ошибка!');
                    }
                }
            });
        } else {
            $('#content-add-form').submit();
        }
    });

    $(document).on('click', '.share span', function () {
        var url = '',
            site = $(this).attr('class'),
            checkUrl = /^(http|https):\/\/([^/:]+)(:\d*)?([^# ]*)/,
            contentId = $(this).closest('div.content-item').attr('id').split('-')[1],
            shareUrl = encodeURIComponent(document.location.href + '#content-' + contentId),
            shareText = encodeURIComponent($('#content-' + contentId).find('div.content-content').text());
        switch (site) {
            case 'facebook':
                url = 'http://www.facebook.com/sharer.php?s=100&p[summary]=' + shareText + '&p[url]=' + shareUrl;
                break;
            case 'vkontakte':
                url = 'http://vkontakte.ru/share.php?url=' + shareUrl + '&description=' + shareText + '&noparse=true';
                break;
            case 'odnoklassniki':
                url = 'http://www.odnoklassniki.ru/dk?st.cmd=addShare&st.s=1&st.comments=' + shareText + '&st._surl=' + shareUrl;
                break;
            case 'plusone':
                url = 'https://plus.google.com/share?url=' + shareUrl;
                break;
        }
        if (checkUrl.test(url)) {
            window.open(url, 'displayWindow', 'width=500, height=400, left=200, top=100, location=no, directories=no, status=no, toolbar=no, menubar=no');
        }
    });
}

function share() {
    $(document).on('click', '.share-site i', function () {
        var url = '',
            site = $(this).attr('class'),
            description = $('meta[name="description"]').attr('content'),
            shareURL = encodeURIComponent(document.location.href),
            checkURL = /^(http|https):\/\/([^/:]+)(:\d*)?([^# ]*)/;
        switch (site) {
            case 'fa fa-facebook':
                url = 'http://www.facebook.com/sharer.php?s=100&p[summary]=' + description + '&p[url]=' + shareURL;
                break;
            case 'fa fa-vk':
                url = 'http://vkontakte.ru/share.php?url=' + shareURL + '&description=' + description + '&noparse=true';
                break;
            case 'fa fa-odnoklassniki':
                url = 'http://www.odnoklassniki.ru/dk?st.cmd=addShare&st.s=1&st.comments=' + description + '&st._surl=' + shareURL;
                break;
            case 'fa fa-google-plus':
                url = 'https://plus.google.com/share?url=' + shareURL;
                break;
        }
        if (checkURL.test(url)) {
            window.open(url, 'displayWindow', 'width=500, height=400, left=200, top=100, location=no, directories=no, status=no, toolbar=no, menubar=no');
        }
    });
}

function validateFeedbackForm() {
    $('#feedback-form').bootstrapValidator({
        fields: {
            'name': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    }
                }
            },
            'email': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    emailAddress: {
                        message: 'Введите корректный адрес электронной почты.'
                    }
                }
            },
            'message': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    }
                }
            },
            'captcha': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    stringLength: {
                        min: 5,
                        max: 5,
                        message: 'Введите защитный код.'
                    }
                }
            }
        }
    });
}

function validateCommentForm() {
    $('#comment-form-add').bootstrapValidator({
        fields: {
            'name': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    }
                }
            },
            'email': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    emailAddress: {
                        message: 'Введите корректный адрес электронной почты.'
                    }
                }
            },
            'message': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    }
                }
            },
            'captcha': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    integer: {
                        message: 'The value is not an integer'
                    },
                    stringLength: {
                        min: 5,
                        max: 5,
                        message: 'Введите защитный код.'
                    }
                }
            }
        }
    });
}

function validateContentForm() {
    $('#content-add-form').bootstrapValidator({
        fields: {
            'content': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    }
                }
            },
            'captcha': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    stringLength: {
                        min: 5,
                        max: 5,
                        message: 'Введите защитный код.'
                    }
                }
            }
        }
    });
}

function validateSubscribeForm() {
    $('#subscribe-form').bootstrapValidator({
        fields: {
            'semail': {
                validators: {
                    notEmpty: {
                        message: 'Не может быть пустым.'
                    },
                    emailAddress: {
                        message: 'Введите корректный адрес электронной почты.'
                    }
                }
            }
        }
    });
}


